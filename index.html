<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Аналітика Продажів | Vape & Hookah</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .glass-card { background: white; border: 1px solid #e2e8f0; }
        .custom-scrollbar::-webkit-scrollbar { height: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        select { background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e"); background-position: right 0.5rem center; background-repeat: no-repeat; background-size: 1.5em 1.5em; padding-right: 2.5rem; -webkit-appearance: none; appearance: none; }
        
        /* Стилі для іконок сортування */
        .sort-icon::after { content: '↕'; margin-left: 8px; opacity: 0.3; font-size: 0.8em; }
        .sort-asc::after { content: '↑'; opacity: 1; color: #2563eb; }
        .sort-desc::after { content: '↓'; opacity: 1; color: #2563eb; }
    </style>
</head>
<body class="bg-[#f8fafc] text-slate-900 antialiased pb-12">
    <div class="container mx-auto px-4 py-8 max-w-7xl">
        <!-- Header -->
        <header class="mb-10">
            <h1 class="text-3xl font-extrabold text-slate-900">Аналітичний Дашборд</h1>
        </header>

        <!-- KPI Cards -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-10">
            <div class="glass-card rounded-2xl p-6 shadow-sm">
                <p class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Виторг (весь період)</p>
                <h3 class="text-2xl font-bold text-slate-800" id="totalRevenue">0 ₴</h3>
            </div>
            <div class="glass-card rounded-2xl p-6 shadow-sm">
                <p class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Прибуток (весь період)</p>
                <h3 class="text-2xl font-bold text-emerald-600" id="totalMargin">0 ₴</h3>
            </div>
            <div class="glass-card rounded-2xl p-6 shadow-sm">
                <p class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Сер. Маржа</p>
                <h3 class="text-2xl font-bold text-amber-600" id="avgMargin">0%</h3>
            </div>
            <div class="glass-card rounded-2xl p-6 shadow-sm border-l-4 border-blue-500">
                <p class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Топ Категорія</p>
                <h3 class="text-xl font-bold text-slate-800" id="topCatName">---</h3>
            </div>
        </div>

        <!-- Main Trend Chart -->
        <div class="glass-card rounded-3xl p-6 mb-10 shadow-sm">
            <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center mb-8 gap-4">
                <div class="flex items-center gap-4">
                    <h2 class="text-xl font-bold">Динаміка за категоріями</h2>
                    <select id="trendMonthFilter" onchange="updateMainChart()" class="text-sm font-semibold border border-slate-200 rounded-lg px-3 py-1.5 bg-slate-50 focus:ring-2 focus:ring-blue-500 outline-none">
                        <option value="all">Весь період</option>
                        <option value="0">Вересень '25</option>
                        <option value="1">Жовтень '25</option>
                        <option value="2">Листопад '25</option>
                        <option value="3">Грудень '25</option>
                        <option value="4">Січень '26</option>
                    </select>
                </div>
                <div class="flex flex-wrap gap-2 custom-scrollbar overflow-x-auto pb-2 max-w-full">
                    <button onclick="selectCategory('all')" id="btn-all" class="category-btn px-4 py-1.5 rounded-full text-xs font-bold uppercase bg-slate-900 text-white transition-all">Всього</button>
                    <div id="categoryButtonContainer" class="flex gap-2"></div>
                </div>
            </div>
            <div class="h-[400px]">
                <canvas id="mainChart"></canvas>
            </div>
        </div>

        <!-- Pie Charts Section -->
        <div class="mb-10">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold">Розподіл часток</h2>
                <div class="flex items-center gap-2">
                    <span class="text-sm text-slate-500">Період:</span>
                    <select id="unifiedPieFilter" onchange="updatePieCharts()" class="text-sm font-semibold border border-slate-200 rounded-lg px-3 py-1.5 bg-white shadow-sm focus:ring-2 focus:ring-blue-500 outline-none">
                        <option value="all">Весь період</option>
                        <option value="0">Вересень '25</option>
                        <option value="1">Жовтень '25</option>
                        <option value="2">Листопад '25</option>
                        <option value="3">Грудень '25</option>
                        <option value="4">Січень '26</option>
                    </select>
                </div>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="glass-card rounded-3xl p-6 shadow-sm text-center">
                    <h3 class="text-slate-500 text-xs font-bold uppercase tracking-widest mb-6 text-left">Виторг за категоріями</h3>
                    <div class="h-80"><canvas id="revenuePieChart"></canvas></div>
                </div>
                <div class="glass-card rounded-3xl p-6 shadow-sm text-center">
                    <h3 class="text-slate-500 text-xs font-bold uppercase tracking-widest mb-6 text-left">Прибуток за категоріями</h3>
                    <div class="h-80"><canvas id="marginPieChart"></canvas></div>
                </div>
            </div>
        </div>

        <!-- Table -->
        <div class="glass-card rounded-3xl shadow-sm overflow-hidden border border-slate-200">
            <div class="p-6 border-b border-slate-100 flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                <div class="flex items-center gap-4">
                    <h2 class="text-xl font-bold">Таблиця даних</h2>
                    <select id="tableMonthFilter" onchange="populateTable()" class="text-sm border border-slate-200 rounded-lg px-3 py-1 bg-slate-50">
                        <option value="all">Весь період</option>
                        <option value="0">Вересень '25</option><option value="1">Жовтень '25</option><option value="2">Листопад '25</option><option value="3">Грудень '25</option><option value="4">Січень '26</option>
                    </select>
                </div>
                <div class="relative w-full md:w-64">
                    <input type="text" id="searchInput" onkeyup="filterTable()" placeholder="Шукати категорію..." class="w-full pl-4 pr-4 py-2 bg-slate-50 border border-slate-200 rounded-xl text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
            </div>
            <div class="overflow-x-auto">
                <table id="dataTable" class="w-full text-left">
                    <thead>
                        <tr class="bg-slate-50/50">
                            <th class="px-6 py-4 text-xs font-bold text-slate-500 uppercase cursor-pointer sort-icon" onclick="sortTable(0, this)">Категорія</th>
                            <th class="px-6 py-4 text-right text-xs font-bold text-slate-500 uppercase cursor-pointer sort-icon" onclick="sortTable(1, this)">Виторг</th>
                            <th class="px-6 py-4 text-right text-xs font-bold text-slate-500 uppercase cursor-pointer sort-icon" onclick="sortTable(2, this)">Прибуток</th>
                            <th class="px-6 py-4 text-right text-xs font-bold text-slate-500 uppercase cursor-pointer sort-icon" onclick="sortTable(3, this)">Доля у виторгу</th>
                            <th class="px-6 py-4 text-right text-xs font-bold text-slate-500 uppercase cursor-pointer sort-icon" onclick="sortTable(4, this)">Доля у маржі</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody" class="divide-y divide-slate-100"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const rawData = [
            { cat: 'Готові рідини', revenue: 8984755, margin: 4235212, revH: [1857405, 1861045, 1798970, 1796870, 1670465], marH: [781519, 849594, 891520, 883453, 829124] },
            { cat: 'Картриджі', revenue: 5014629, margin: 1940559, revH: [985614, 921566, 1014386, 1042002, 1050671], marH: [433939, 392112, 384402, 385480, 344599] },
            { cat: 'Компоненти', revenue: 4100968, margin: 1879133, revH: [806958, 698870, 811495, 858213, 925432], marH: [290807, 351588, 344011, 426205, 466518] },
            { cat: 'Поди', revenue: 2376316, margin: 821681, revH: [504001, 436005, 492561, 539194, 404555], marH: [139465, 156963, 171138, 199451, 154663] },
            { cat: 'Чайна суміш', revenue: 338863, margin: 88307, revH: [64537, 61466, 75931, 73419, 63510], marH: [8181, 20669, 18377, 21800, 19277] },
            { cat: 'Випарники', revenue: 265875, margin: 111615, revH: [82095, 44850, 51375, 51985, 35570], marH: [35770, 19224, 21234, 20575, 14810] },
            { cat: 'Одноразки', revenue: 178400, margin: 89932, revH: [0, 1700, 20200, 81200, 75300], marH: [0, 988, 10994, 40284, 37664] },
            { cat: 'Снюс', revenue: 54695, margin: 15310, revH: [11975, 9700, 8675, 11665, 12680], marH: [3579, 2967, 2168, 3205, 3389] },
            { cat: 'CBD', revenue: 68531, margin: 19218, revH: [17965, 14514, 16691, 14562, 4799], marH: [4552, 5326, 4715, 3583, 1040] },
            { cat: 'Кальяни', revenue: 46848, margin: 17765, revH: [8789, 9897, 7724, 10531, 9964], marH: [3833, 3926, 3093, 4026, 2882] }
        ];

        const months = ["Вер '25", "Жов '25", "Лис '25", "Гру '25", "Січ '26"];
        const chartColors = ['#2563eb', '#10b981', '#f59e0b', '#8b5cf6', '#ec4899', '#14b8a6', '#f97316', '#6366f1', '#84cc16', '#06b6d4'];
        let mainChart, revenuePieChart, marginPieChart;
        let activeCategory = 'all';

        function init() {
            createCategoryButtons();
            initMainChart();
            initPieCharts();
            populateTable();
            updateKPIs();
        }

        function updateKPIs() {
            const tr = rawData.reduce((s, i) => s + i.revenue, 0);
            const tm = rawData.reduce((s, i) => s + i.margin, 0);
            document.getElementById('totalRevenue').textContent = formatNumber(tr) + ' ₴';
            document.getElementById('totalMargin').textContent = formatNumber(tm) + ' ₴';
            document.getElementById('avgMargin').textContent = (tm/tr*100).toFixed(1) + '%';
            const top = [...rawData].sort((a,b) => b.revenue - a.revenue)[0];
            document.getElementById('topCatName').textContent = top.cat;
        }

        function createCategoryButtons() {
            const container = document.getElementById('categoryButtonContainer');
            rawData.forEach((item, idx) => {
                const btn = document.createElement('button');
                btn.id = `btn-${idx}`;
                btn.className = "category-btn px-4 py-1.5 rounded-full text-xs font-bold uppercase bg-white text-slate-600 border border-slate-200 hover:border-slate-300 whitespace-nowrap";
                btn.textContent = item.cat;
                btn.onclick = () => selectCategory(idx);
                container.appendChild(btn);
            });
        }

        function initMainChart() {
            const ctx = document.getElementById('mainChart').getContext('2d');
            mainChart = new Chart(ctx, {
                type: 'line',
                data: { labels: months, datasets: [] },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    scales: {
                        y: { position: 'left', title: { display: true, text: 'Сума (₴)' }, ticks: { callback: v => formatNumber(v) } },
                        y1: { position: 'right', min: 0, max: 100, title: { display: true, text: 'Частка (%)' }, ticks: { callback: v => v + '%' }, grid: { drawOnChartArea: false } }
                    },
                    plugins: { 
                        legend: { position: 'bottom' },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) label += ': ';
                                    if (context.dataset.yAxisID === 'y1') {
                                        label += context.parsed.y + '%';
                                    } else {
                                        label += formatNumber(context.parsed.y) + ' ₴';
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
            updateMainChart();
        }

        function updateMainChart() {
            const revTotals = months.map((_, i) => rawData.reduce((s, item) => s + item.revH[i], 0));
            const marTotals = months.map((_, i) => rawData.reduce((s, item) => s + item.marH[i], 0));
            
            let datasets = [];
            if (activeCategory === 'all') {
                datasets = [
                    { label: 'Виторг (загальний)', data: revTotals, borderColor: '#2563eb', backgroundColor: 'rgba(37, 99, 235, 0.1)', fill: true, tension: 0.4, yAxisID: 'y' },
                    { label: 'Прибуток (загальний)', data: marTotals, borderColor: '#10b981', tension: 0.4, yAxisID: 'y' },
                    { 
                        label: 'Сер. Маржа мережі %', 
                        data: marTotals.map((m, i) => (m / revTotals[i] * 100).toFixed(1)), 
                        borderColor: '#f59e0b', 
                        borderDash: [5, 5], 
                        tension: 0.4, 
                        yAxisID: 'y1' 
                    }
                ];
            } else {
                const d = rawData[activeCategory];
                datasets = [
                    { label: `Виторг: ${d.cat}`, data: d.revH, borderColor: '#2563eb', tension: 0.4, yAxisID: 'y' },
                    { label: `Прибуток: ${d.cat}`, data: d.marH, borderColor: '#10b981', tension: 0.4, yAxisID: 'y' },
                    { 
                        label: `Доля у виторгу %`, 
                        data: d.revH.map((v, i) => (v / revTotals[i] * 100).toFixed(1)), 
                        borderColor: '#f59e0b', 
                        borderDash: [5, 5], 
                        borderWidth: 2,
                        tension: 0.4, 
                        yAxisID: 'y1' 
                    },
                    { 
                        label: `Доля у прибутку %`, 
                        data: d.marH.map((v, i) => (v / marTotals[i] * 100).toFixed(1)), 
                        borderColor: '#8b5cf6', 
                        borderDash: [2, 2], 
                        borderWidth: 2,
                        tension: 0.4, 
                        yAxisID: 'y1' 
                    }
                ];
            }

            mainChart.data.datasets = datasets;
            mainChart.update();
        }

        function selectCategory(idx) {
            activeCategory = idx;
            document.querySelectorAll('.category-btn').forEach(b => b.className = "category-btn px-4 py-1.5 rounded-full text-xs font-bold uppercase bg-white text-slate-600 border border-slate-200 whitespace-nowrap");
            const btn = idx === 'all' ? document.getElementById('btn-all') : document.getElementById(`btn-${idx}`);
            btn.className = "category-btn px-4 py-1.5 rounded-full text-xs font-bold uppercase bg-slate-900 text-white whitespace-nowrap";
            updateMainChart();
        }

        function initPieCharts() {
            const commonOptions = {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '65%',
                plugins: {
                    legend: {
                        position: 'right',
                        labels: {
                            boxWidth: 12,
                            padding: 15,
                            font: { size: 11 },
                            generateLabels: (chart) => {
                                const data = chart.data;
                                if (data.labels.length && data.datasets.length) {
                                    const total = data.datasets[0].data.reduce((a, b) => a + b, 0);
                                    return data.labels.map((label, i) => {
                                        const value = data.datasets[0].data[i];
                                        const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                        return {
                                            text: `${label} (${percentage}%)`,
                                            fillStyle: data.datasets[0].backgroundColor[i],
                                            hidden: isNaN(data.datasets[0].data[i]) || chart.getDatasetMeta(0).data[i].hidden,
                                            index: i
                                        };
                                    });
                                }
                                return [];
                            }
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = total > 0 ? ((context.parsed / total) * 100).toFixed(1) : 0;
                                return `${context.label}: ${formatNumber(context.parsed)} ₴ (${percentage}%)`;
                            }
                        }
                    }
                }
            };

            revenuePieChart = new Chart(document.getElementById('revenuePieChart'), {
                type: 'doughnut',
                data: {
                    labels: rawData.map(i => i.cat),
                    datasets: [{ data: rawData.map(i => i.revenue), backgroundColor: chartColors }]
                },
                options: commonOptions
            });

            marginPieChart = new Chart(document.getElementById('marginPieChart'), {
                type: 'doughnut',
                data: {
                    labels: rawData.map(i => i.cat),
                    datasets: [{ data: rawData.map(i => i.margin), backgroundColor: chartColors }]
                },
                options: commonOptions
            });
        }

        function updatePieCharts() {
            const filter = document.getElementById('unifiedPieFilter').value;
            
            revenuePieChart.data.datasets[0].data = filter === 'all' ? rawData.map(i => i.revenue) : rawData.map(i => i.revH[parseInt(filter)]);
            marginPieChart.data.datasets[0].data = filter === 'all' ? rawData.map(i => i.margin) : rawData.map(i => i.marH[parseInt(filter)]);
            
            revenuePieChart.update();
            marginPieChart.update();
        }

        function populateTable() {
            const filter = document.getElementById('tableMonthFilter').value;
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';
            
            const totalRev = (filter === 'all') ? rawData.reduce((s,i) => s + i.revenue, 0) : rawData.reduce((s,i) => s + i.revH[parseInt(filter)], 0);
            const totalMar = (filter === 'all') ? rawData.reduce((s,i) => s + i.margin, 0) : rawData.reduce((s,i) => s + i.marH[parseInt(filter)], 0);

            rawData.forEach(item => {
                const rev = filter === 'all' ? item.revenue : item.revH[parseInt(filter)];
                const mar = filter === 'all' ? item.margin : item.marH[parseInt(filter)];
                if (filter !== 'all' && rev === 0) return;
                
                const revShare = totalRev > 0 ? (rev / totalRev * 100).toFixed(1) : 0;
                const marShare = totalMar > 0 ? (mar / totalMar * 100).toFixed(1) : 0;

                const row = tbody.insertRow();
                row.innerHTML = `
                    <td class="px-6 py-4 text-sm font-semibold text-slate-700">${item.cat}</td>
                    <td class="px-6 py-4 text-sm text-right font-mono">${formatNumber(rev)} ₴</td>
                    <td class="px-6 py-4 text-sm text-right font-mono text-emerald-600">${formatNumber(mar)} ₴</td>
                    <td class="px-6 py-4 text-right text-sm text-blue-600 font-bold">${revShare}%</td>
                    <td class="px-6 py-4 text-right text-sm text-amber-600 font-bold">${marShare}%</td>
                `;
            });
        }

        function formatNumber(n) { return new Intl.NumberFormat('uk-UA').format(Math.round(n)); }
        
        function filterTable() {
            let q = document.getElementById('searchInput').value.toLowerCase();
            Array.from(document.getElementById('tableBody').rows).forEach(r => r.style.display = r.cells[0].innerText.toLowerCase().includes(q) ? '' : 'none');
        }

        function sortTable(n, el) {
            const table = document.getElementById("dataTable");
            const headers = table.querySelectorAll('th');
            let rows = Array.from(table.rows).slice(1);
            let dir = el.classList.contains("sort-asc") ? "desc" : "asc";
            
            // Очищення класів сортування з усіх заголовків
            headers.forEach(h => {
                h.classList.remove("sort-asc", "sort-desc");
            });
            
            // Додавання класу до поточного заголовка
            el.classList.add(dir === "asc" ? "sort-asc" : "sort-desc");

            rows.sort((a,b) => {
                let x = a.cells[n].innerText.replace(/[₴,%\s]/g, '').replace(',', '.');
                let y = b.cells[n].innerText.replace(/[₴,%\s]/g, '').replace(',', '.');
                
                // Якщо це не число (перший стовпець)
                if (isNaN(x)) {
                    return dir === "asc" ? x.localeCompare(y) : y.localeCompare(x);
                }
                
                return dir === "asc" ? parseFloat(x) - parseFloat(y) : parseFloat(y) - parseFloat(x);
            });
            
            rows.forEach(r => table.tBodies[0].appendChild(r));
        }

        window.onload = init;
    </script>
</body>
</html>
